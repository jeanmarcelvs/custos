import{buscarEProcessarProjeto}from"./model.js";import{formatarMoeda}from"./utils.js";function $(e){return document.getElementById(e)}localStorage.getItem("authToken")||(window.location.href="index.html");const params=new URLSearchParams(location.search),projectId=params.get("projectId"),overlay=$("loading-overlay"),projectSearchContainer=$("project-search-container"),projectDetailsContainer=$("project-details-container"),projectSearchForm=$("project-search-form");function mostrarLoading(e=!0){overlay?.classList.toggle("oculto",!e)}async function carregar(e){if(!e){projectDetailsContainer?.classList.add("oculto"),projectSearchContainer?.classList.remove("oculto"),projectSearchForm?.addEventListener("submit",e=>{e.preventDefault();const o=$("project-id-input").value;o&&(window.location.href=`projeto.html?projectId=${encodeURIComponent(o)}`)});return}mostrarLoading(!0);try{const o=await buscarEProcessarProjeto(e);projectDetailsContainer?.classList.remove("oculto"),projectSearchContainer?.classList.add("oculto"),o?(($("proj-title").innerHTML+=`<span class="project-id-tag">#${o.id}</span>`),$("client-name-placeholder").textContent=o.nomeCliente??"Cliente não informado",$("info-data").textContent=new Date(o.dataCriacao).toLocaleDateString("pt-BR"),$("val-total-projeto").textContent=formatarMoeda(Number(o.valorProposta??0)),valorKit=Number(o.valorKit??0),$("val-kit").textContent=formatarMoeda(valorKit),valorProposta=Number(o.valorProposta??0),valorGDIS=valorProposta-valorKit,totalCustos=Number(o.totais?.totalGeral??0),valorImposto=.12*valorGDIS,lucroSemImposto=valorGDIS-totalCustos,lucroComImposto=lucroSemImposto-valorImposto,$("val-gdis").textContent=formatarMoeda(valorGDIS),$("val-custos").textContent=formatarMoeda(totalCustos),$("val-lucro-sem-imposto").textContent=formatarMoeda(lucroSemImposto),$("val-imposto").textContent=formatarMoeda(valorImposto),$("val-lucro-com-imposto").textContent=formatarMoeda(lucroComImposto),$("val-total-projeto").closest(".kpi").classList.add("kpi-neutral"),$("val-kit").closest(".kpi").classList.add("kpi-neutral"),$("val-lucro-sem-imposto").closest(".kpi").classList.add("kpi-lucro-bruto"),$("val-custos").closest(".kpi").classList.add("kpi-cost"),$("val-imposto").closest(".kpi").classList.add("kpi-cost"),kpiLucroCard=$("val-lucro-com-imposto").closest(".kpi"),kpiLucroCard.classList.remove("kpi-profit-good","kpi-profit-warning","kpi-profit-bad"),margemDeLucro=valorGDIS>0?lucroComImposto/valorGDIS*100:0,margemDeLucro>17?kpiLucroCard.classList.add("kpi-profit-good"):margemDeLucro>=13?kpiLucroCard.classList.add("kpi-profit-warning"):kpiLucroCard.classList.add("kpi-profit-bad"),$("break-material").textContent=formatarMoeda(Number(o.totais?.material??0)),$("break-diarias").textContent=formatarMoeda(Number(o.totais?.diarias??0)),$("break-combustivel").textContent=formatarMoeda(Number(o.totais?.combustivel??0)),$("break-outras").textContent=formatarMoeda(Number(o.totais?.outras??0))):(alert("Erro ao carregar projeto. Veja console."),$("client-name-placeholder").textContent=`Projeto #${e} não encontrado.`)}catch(e){$("client-name-placeholder").textContent="Falha ao carregar dados.",console.error(e),alert("Erro ao carregar projeto. Veja console.")}finally{mostrarLoading(!1)}}let valorKit,valorProposta,valorGDIS,totalCustos,valorImposto,lucroSemImposto,lucroComImposto,kpiLucroCard,margemDeLucro;document.getElementById("btn-edit-page").addEventListener("click",()=>{projectId?window.location.href=`editar-projeto.html?projectId=${encodeURIComponent(projectId)}`:alert("Nenhum projeto selecionado.")}),document.getElementById("btn-logout").addEventListener("click",()=>{localStorage.removeItem("authToken"),window.location.href="index.html"}),document.getElementById("btn-logout-search").addEventListener("click",()=>{localStorage.removeItem("authToken"),window.location.href="index.html"}),document.getElementById("btn-refresh").addEventListener("click",()=>location.reload()),carregar(projectId);